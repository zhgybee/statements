<!doctype html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
<title></title>
<link rel="stylesheet" href="../style/css/app.css" />
<link rel="stylesheet" href="../lib/font-awesome/css/font-awesome.min.css" />
<link rel="stylesheet" href="../lib/datagrid/datagrid.css" />
<link rel="stylesheet" href="../lib/selection/selection.css"/>

<script type="text/javascript" src="../lib/jquery.js"></script>
<script type="text/javascript" src="../lib/app.js"></script>
<script type="text/javascript" src="../lib/datagrid/datagrid.js"></script>
<script type="text/javascript" src="../lib/calendar/jquery.calendar.js"></script>
<script type="text/javascript" src="../system/datastructure/datastructure.js"></script>
<script type="text/javascript" src="../lib/calendar/jquery.calendar.js"></script>
<script type="text/javascript" src="../lib/selection/selection.js"></script>

<style>
html, body{height:100%}
</style>


<script type="text/javascript">

	var id = app.getParameter("id");
	var code = app.getParameter("code");
	var name = app.getParameter("name");

	var structureutils = new DataStructureUtils();
	
	$(function()
	{ 
		resize();
		$(window).resize( function(){resize()} ); 
		initialize();
	});

	function initialize()
	{
		var button = 
		[
			{
				id:"copy-button",
				title:"复制", 
				style:"background-color:#fffeda; margin-right:2px",
				onclick:function(event)
				{
					var id = $(this).parents("tr").data("row").ID;
					copy([id]);
					event.stopPropagation();
				}
			},
			{
				id:"delete-button",
				title:"删除", 
				style:"background-color:#ffe8e8",
				onclick:function(event)
				{
					var id = $(this).parents("tr").data("row").ID;
					del([id]);
					event.stopPropagation();
				}
			}
		];
		
		var fixedcolumns = 			
		[
			{id:"index-panel", index:true},
			{id:"checkbox-panel", checkbox:true},
			{id:"button-panel", button:button, datagrid:{style:{width:"70px"}}}
		];
		$.getJSON(app.getContextPath()+"/system/datastructure/column.jsp?code="+code, function(response)
		{
			var datagridcolumns = structureutils.columns(response);
			var frozencolumns = datagridcolumns.frozencolumns;
			var columns = datagridcolumns.columns;
			var searcher = [{table:name, column:"TASK_ID", "operator":"=", "value":id}];
			
			$(".datagrid").datagrid(
			{
				datasource:
				{
					url:app.getContextPath()+"/system/datastructure/dataset.jsp", 
					args:
					{
						columns:encodeURIComponent(JSON.stringify(frozencolumns.concat(columns))),
						searcher:encodeURIComponent(JSON.stringify(searcher))
					}
				},
				editor:
				{
					action:app.getContextPath()+"/system/datastructure/action.jsp?mode=1"
				},
				fixedcolumns:fixedcolumns,
				frozencolumns:frozencolumns,
				columns:columns
			});
		});

		$("#add-button").on("click", function()
		{
			app.showLoading();
			$.getJSON(app.getContextPath()+"/system/datastructure/action.jsp?mode=2&id="+id+"&name="+name, function(response)
			{
				app.hideLoading();
				if(response.status == "1")
				{
					$(".datagrid").datagrid("url");
				}
				else 
				{
					app.message(response.messages);
				}
			});
		});

		$("#copy-button").on("click", function()
		{
			var rows = $(".datagrid").datagrid("getSelections");
			var ids = [];
			$.each(rows, function(i, row)
			{
				ids.push(row.ID);
			});
			if(ids.length > 0)
			{
				copy(ids);
			}
		});

		$("#delete-button").on("click", function()
		{
			var rows = $(".datagrid").datagrid("getSelections");
			var ids = [];
			$.each(rows, function(i, row)
			{
				ids.push(row.ID);
			});
			if(ids.length > 0)
			{
				del(ids);
			}
		});
	}

	function copy(ids)
	{
		app.showLoading();
		$.getJSON(app.getContextPath()+"/system/datastructure/action.jsp?mode=3&ids="+ids.join(",")+"&name="+name, function(response)
		{
			app.hideLoading();
			if(response.status == "1")
			{
				$(".datagrid").datagrid("url");
			}
			else 
			{
				app.message(response.messages);
			}
		});
	}

	function del(ids)
	{
		app.showLoading();
		$.getJSON(app.getContextPath()+"/system/datastructure/action.jsp?mode=4&ids="+ids.join(",")+"&name="+name, function(response)
		{
			app.hideLoading();
			if(response.status == "1")
			{
				$(".datagrid").datagrid("url");
			}
			else 
			{
				app.message(response.messages);
			}
		});
	}

	function resize()
	{

		$("#editor-panel").height( $(window).outerHeight() - $("#toolbar-panel").outerHeight(true) - 2 );
	}
	
</script>

</head>
<body>
<div style="box-sizing:border-box; padding:10px; background-color:#F7F7F7" id="toolbar-panel" class="grid-toolbar-panel clearfix">
	<div class="left">
		<button style="height:35px; width:80px" id="add-button">增加</button>
		<button style="height:35px; width:80px" id="copy-button">复制</button>
		<button style="height:35px; width:80px" class="red" id="delete-button">删除</button>
	</div>
	<div class="searcher-panel right">
		<div class="searcher-keyword-panel"><input type="text" placeholder="请输入搜索内容..."/><i class="fa fa-search"></i></div>
	</div>
</div>
<div class="datagrid" id="editor-panel" style="overflow:hidden; width:100%;"></div>
</body>
</html>