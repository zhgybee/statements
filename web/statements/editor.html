<!doctype html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
<title></title>
<link rel="stylesheet" href="../style/css/app.css" />
<link rel="stylesheet" href="../lib/font-awesome/css/font-awesome.min.css" />
<link rel="stylesheet" href="../lib/datagrid/datagrid.css" />
<link rel="stylesheet" href="../lib/selection/selection.css"/>
<style>
html, body{height:100%}
</style>
</head>
<body>
<div style="box-sizing:border-box; padding:10px; background-color:#F7F7F7" id="toolbar-panel" class="grid-toolbar-panel clearfix">
	<div class="left">
		<button style="height:35px; width:80px" id="add-button">增加</button>
		<button style="height:35px; width:80px" id="copy-button">复制</button>
		<button style="height:35px; width:80px" class="red" id="delete-button">删除</button>
	</div>
	<div class="searcher-panel right">
		<div class="searcher-keyword-panel"><input type="text" placeholder="请输入搜索内容..."/><i class="fa fa-search"></i></div>
	</div>
</div>
<div class="datagrid" id="editor-panel" style="overflow:hidden; width:100%;"></div>

<script type="text/javascript" src="../lib/jquery.js"></script>
<script type="text/javascript" src="../lib/app.js"></script>
<script type="text/javascript" src="../lib/datagrid/datagrid.js"></script>
<script type="text/javascript" src="../lib/calendar/jquery.calendar.js"></script>
<script type="text/javascript" src="../system/datastructure/datastructure.js"></script>
<script type="text/javascript" src="../lib/calendar/jquery.calendar.js"></script>
<script type="text/javascript" src="../lib/selection/selection.js"></script>

<script type="text/javascript">

	var code = app.getParameter("code");
	var statementId = app.getParameter("statement");
	var substatementId = app.getParameter("substatement");
	var merge = app.getParameter("merge") || 0;
	var children = app.getParameter("children");

	var datastructure = null;

	var structureutils = new DataStructureUtils();
	
	$(function()
	{ 
		resize();
		$(window).resize( function(){resize()} ); 

		app.showLoading();

		$.getJSON("statement.jsp?mode=4", {code:code}, function(response)
		{
			app.hideLoading();
			if(response.status == "1")
			{
				datastructure = response.resource.datastructure;
				if(datastructure != null)
				{
					initialize();
				}
				else
				{
					app.message("表格配置文件错误");
				}
			}
			else 
			{
				app.message(response.messages);
			}
		});

	});

	function initialize()
	{
		var button = 
		[
			{
				id:"copy-button",
				title:"复制", 
				style:"background-color:#fffeda; margin-right:2px",
				onclick:function(event)
				{
					var id = $(this).parents("tr").data("row").ID;
					copy([id]);
					event.stopPropagation();
				}
			},
			{
				id:"delete-button",
				title:"删除", 
				style:"background-color:#ffe8e8",
				onclick:function(event)
				{
					var id = $(this).parents("tr").data("row").ID;
					del([id]);
					event.stopPropagation();
				}
			}
		];
		
		var fixedcolumns = 			
		[
			{id:"index-panel", index:true},
			{id:"checkbox-panel", checkbox:true},
			{id:"button-panel", button:button, datagrid:{style:{width:"70px"}}}
		];
		$.getJSON(app.getContextPath()+"/system/datastructure/column.jsp?code="+code, function(response)
		{
			var datagridcolumns = structureutils.columns(response);
			var frozencolumns = datagridcolumns.frozencolumns;
			var columns = datagridcolumns.columns;

			var searcher = [];
			
			if(merge == "1")
			{
				if(substatementId == "")
				{
					searcher.push( {table:datastructure.name, column:"STATEMENT_ID", operator:"=", value:statementId} );
				}
				else
				{
					children = decodeURI(children);
					searcher.push( {table:datastructure.name, column:"SUBSTATEMENT_ID", operator:"in", value:"("+children+")"} );
				}
			}
			else
			{
				searcher.push( {table:datastructure.name, column:"SUBSTATEMENT_ID", operator:"=", value:substatementId} );
			}

			var sorts = [];
			if(datastructure.sort != null)
			{
				sorts = sorts.concat(datastructure.sort);
			}
			var groups = [];
			if(datastructure.group != null)
			{
				groups = groups.concat(datastructure.group);
			}

			$(".datagrid").datagrid(
			{
				datasource:
				{
					url:app.getContextPath()+"/system/datastructure/dataset.jsp", 
					args:
					{
						columns:encodeURIComponent(JSON.stringify(frozencolumns.concat(columns))),
						searcher:encodeURIComponent(JSON.stringify(searcher)),
						sort:encodeURIComponent(JSON.stringify(sorts))
					}
				},
				editor:
				{
					action:app.getContextPath()+"/system/datastructure/action.jsp?mode=1"
				},
				groups:groups,
				fixedcolumns:fixedcolumns,
				frozencolumns:frozencolumns,
				columns:columns
			});
		});

		$("#add-button").on("click", function()
		{
			app.showLoading();
			$.getJSON(app.getContextPath()+"/system/datastructure/action.jsp?mode=2&statement="+statementId+"&substatement="+substatementId+"&name="+datastructure.name, function(response)
			{
				app.hideLoading();
				if(response.status == "1")
				{
					$(".datagrid").datagrid("url");
				}
				else 
				{
					app.message(response.messages);
				}
			});
		});

		$("#copy-button").on("click", function()
		{
			var rows = $(".datagrid").datagrid("getSelections");
			var ids = [];
			$.each(rows, function(i, row)
			{
				ids.push(row.ID);
			});
			if(ids.length > 0)
			{
				copy(ids);
			}
		});

		$("#delete-button").on("click", function()
		{
			var rows = $(".datagrid").datagrid("getSelections");
			var ids = [];
			$.each(rows, function(i, row)
			{
				ids.push(row.ID);
			});
			if(ids.length > 0)
			{
				del(ids);
			}
		});
	}

	function copy(ids)
	{
		app.showLoading();
		$.getJSON(app.getContextPath()+"/system/datastructure/action.jsp?mode=3&ids="+ids.join(",")+"&code="+datastructure.code, function(response)
		{
			app.hideLoading();
			if(response.status == "1")
			{
				$(".datagrid").datagrid("url");
			}
			else 
			{
				app.message(response.messages);
			}
		});
	}

	function del(ids)
	{
		app.showLoading();
		$.getJSON(app.getContextPath()+"/system/datastructure/action.jsp?mode=4&ids="+ids.join(",")+"&code="+datastructure.code, function(response)
		{
			app.hideLoading();
			if(response.status == "1")
			{
				$(".datagrid").datagrid("url");
			}
			else 
			{
				app.message(response.messages);
			}
		});
	}

	function resize()
	{

		$("#editor-panel").height( $(window).outerHeight() - $("#toolbar-panel").outerHeight(true) - 2 );
	}
	
</script>

</body>
</html>