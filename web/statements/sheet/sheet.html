<!doctype html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
<title></title>
<link rel="stylesheet" href="../../style/css/app.css" />
<link rel="stylesheet" href="../../lib/font-awesome/css/font-awesome.min.css" />
<style>
html, body{height:100%}
</style>
</head>
<body>

<div id="tables" class="tabs"><ul class="clearfix"></ul></div>

<div id="editor-frame" style="position:relative;">
	<iframe frameborder="0" style="width:100%; height:100%; border:none; position:absolute; top:0px; left:0px;"></iframe>
</div>

<div id="statements" class="tabs bottom"><ul class="clearfix"></ul></div>

<script type="text/javascript" src="../../lib/jquery.js"></script>
<script type="text/javascript" src="../../lib/app.js"></script>

<script type="text/javascript">

	var sheetId = app.getParameter("sheet") || "";
	var statementId = app.getParameter("statement") || "";
	var substatementId = app.getParameter("substatement") || "";
	var merge = app.getParameter("merge") || 0;
	var children = app.getParameter("children") || "";
	

	var table = null;
	$(function()
	{ 
		resize();
		$(window).resize( function(){resize()} ); 

		app.showLoading();
		$.getJSON("sheet.jsp?mode=1", {sheet:sheetId, statement:statementId, substatement:substatementId, merge:merge, children:children}, function(response)
		{
			app.hideLoading();
			if(response.status == "1")
			{
				var tables = response.resource.tables;
				var substatements = response.resource.substatements;

				if(tables != null)
				{
					var $selection = null;
					$.each(tables, function(i, table)
					{
						var $tab = $('<li>'+table.name+'</li>');
						$tab.data("table", table);
						$("#tables ul").append($tab);
						if(i == 0)
						{
							$selection = $tab;
						}
					});
					app.tabs($("#tables"), function($tab)
					{
						table = $tab.data("table");
						if(table.url != null)
						{
							$("#editor-frame iframe").attr("src", table.url+"&merge="+merge+"&statement="+statementId+"&substatement="+substatementId+"&children="+children);
						}
						else
						{
							$("#editor-frame iframe").attr("src", "editor.html?merge="+merge+"&table="+table.id+"&statement="+statementId+"&substatement="+substatementId+"&children="+children);
						}
					});

					$selection.click();
				}
				else
				{
					app.message("表格配置文件错误");
				}

				if(merge == "1")
				{
					var $selection = $('<li>合并</li>');
					$("#statements ul").append($selection);


					$.each(substatements, function(i, substatement)
					{
						var $tab = $('<li>'+substatement.TITLE+'</li>');
						$tab.data("substatement", substatement);
						$("#statements ul").append($tab);
					});
					app.tabs($("#statements"), function($tab)
					{
						var substatement = $tab.data("substatement");
						if(substatement == null)
						{
							if(table.url != null)
							{
								$("#editor-frame iframe").attr("src", table.url+"&merge="+merge+"&table="+table.id+"&statement="+statementId+"&substatement="+substatementId+"&children="+children);
							}
							else
							{
								$("#editor-frame iframe").attr("src", "editor.html?merge="+merge+"&table="+table.id+"&statement="+statementId+"&substatement="+substatementId+"&children="+children);
							}
						}
						else
						{
							if(table.url != null)
							{
								$("#editor-frame iframe").attr("src", table.url+"&merge=0&table="+table.id+"&statement="+statementId+"&substatement="+substatement.ID+"&children=");
							}
							else
							{
								$("#editor-frame iframe").attr("src", "editor.html?merge=0&table="+table.id+"&statement="+statementId+"&substatement="+substatement.ID+"&children=");
							}
						}
					});

					$selection.click();

					$("#statements").show();
					
					resize();
				}

			}
			else 
			{
				app.message(response.messages);
			}
		});

	});

	function resize()
	{
		var height = $("#tables").outerHeight(true);
		if($("#statements").is(':visible'))
		{
			height += $("#statements").outerHeight(true);
		}
		$("#editor-frame").height( $(window).outerHeight() - height - 1);
	}
	
</script>

</body>
</html>